{% extends 'base.html' %}
{% load static %}

{% block title %}AtlantaFoodFinder - Discover Atlanta's Best Restaurants{% endblock %}

{% block content %}
<section class="hero">
    <div class="hero-content">
        <h1>Discover Atlanta's Best Eats</h1>
        <form class="hero-search" action="{% url 'search_results' %}" method="get" id="search-form">
            <input type="text" name="q" placeholder="Search for restaurants or cuisines...">
            <select name="cuisine" id="cuisine-filter">
                <option value="">All Cuisines</option>
                {% for cuisine in cuisines %}
                <option value="{{ cuisine.id }}">{{ cuisine.name }}</option>
                {% endfor %}
            </select>
            <button type="submit"><i class="fas fa-search"></i> Find Food</button>
        </form>
    </div>
</section>

<section class="map-section">
    <div class="container">
        <h2>Explore Restaurants in Atlanta</h2>
        <div class="map-controls">
            <button id="geolocate-btn"><i class="fas fa-map-marker-alt"></i> Find Restaurants Near Me</button>
            <select id="rating-filter">
                <option value="">All Ratings</option>
                <option value="4">4+ Stars</option>
                <option value="3">3+ Stars</option>
                <option value="2">2+ Stars</option>
            </select>
        </div>
        <div id="map" style="height: 500px; width: 100%;"></div>
    </div>
</section>

<section class="featured-restaurants">
    <div class="container">
        <div class="restaurant-grid" id="restaurant-list">
            {% for restaurant in top_restaurants %}
            <div class="restaurant-card" data-lat="{{ restaurant.latitude }}" data-lng="{{ restaurant.longitude }}" data-id="{{ restaurant.id }}">
                <img src="{{ restaurant.image.url }}" alt="{{ restaurant.name }}">
                <div class="restaurant-card-content">
                    <h3>{{ restaurant.name }}</h3>
                    <p><strong>Cuisine:</strong> {{ restaurant.cuisine }}</p>
                    <p><strong>Rating:</strong> {{ restaurant.rating }} ⭐</p>
                    <p><strong>Address:</strong> {{ restaurant.address }}</p>
                    <p><strong>Hours:</strong> {{ restaurant.opening_hours }}</p>
                    <a href="{% url 'restaurant_detail' restaurant.id %}" class="btn-view">View Details</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/home.js' %}"></script>
<script>
    let map;
    const restaurants = [
        {% for restaurant in top_restaurants %}
        {
            id: {{ restaurant.id }},
            name: "{{ restaurant.name }}",
            lat: {{ restaurant.latitude|default_if_none:0 }},
            lng: {{ restaurant.longitude|default_if_none:0 }},
            cuisine: "{{ restaurant.cuisine }}",
            rating: {{ restaurant.rating }},
        },
        {% endfor %}
    ];

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 33.7490, lng: -84.3880 }, // Atlanta coordinates
            zoom: 12,
        });

        const markers = restaurants.map(restaurant => {
            if (restaurant.lat && restaurant.lng) {
                const marker = new google.maps.Marker({
                    position: { lat: restaurant.lat, lng: restaurant.lng },
                    map: map,
                    title: restaurant.name,
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `<h3>${restaurant.name}</h3><p>Cuisine: ${restaurant.cuisine}</p><p>Rating: ${restaurant.rating} ⭐</p>`
                });

                marker.addListener("click", () => {
                    infoWindow.open(map, marker);
                });

                return marker;
            }
            return null;
        }).filter(marker => marker !== null);

        // Add geolocation feature
        document.getElementById("geolocate-btn").addEventListener("click", () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        map.setCenter(pos);
                        map.setZoom(14);
                    },
                    () => {
                        alert("Error: The Geolocation service failed.");
                    }
                );
            } else {
                alert("Error: Your browser doesn't support geolocation.");
            }
        });

        // Add filtering functionality
        document.getElementById("cuisine-filter").addEventListener("change", filterRestaurants);
        document.getElementById("rating-filter").addEventListener("change", filterRestaurants);

        function filterRestaurants() {
            const selectedCuisine = document.getElementById("cuisine-filter").value;
            const selectedRating = document.getElementById("rating-filter").value;

            markers.forEach((marker, i) => {
                const restaurant = restaurants[i];
                const cuisineMatch = !selectedCuisine || restaurant.cuisine == selectedCuisine;
                const ratingMatch = !selectedRating || restaurant.rating >= parseFloat(selectedRating);

                if (cuisineMatch && ratingMatch) {
                    marker.setMap(map);
                } else {
                    marker.setMap(null);
                }
            });
        }
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>
{% endblock %}