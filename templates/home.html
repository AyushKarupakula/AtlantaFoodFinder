{% extends 'base.html' %}
{% load static %}

{% block title %}AtlantaFoodFinder - Discover Atlanta's Best Restaurants{% endblock %}

{% block content %}
<section class="hero">
    <div class="hero-content">
        <h1>Discover Atlanta's Best Eats</h1>
        <form class="hero-search" action="{% url 'search_results' %}" method="get" id="search-form">
            <input type="text" name="q" placeholder="Search for restaurants or cuisines...">
            <select name="cuisine" id="cuisine-filter">
                <option value="">All Cuisines</option>
                {% for cuisine in cuisines %}
                    <option value="{{ cuisine.id }}">{{ cuisine.name }}</option>
                {% endfor %}
                {% if 'italian' not in cuisines %}<option value="italian">Italian</option>{% endif %}
                {% if 'indian' not in cuisines %}<option value="indian">Indian</option>{% endif %}
                {% if 'chinese' not in cuisines %}<option value="chinese">Chinese</option>{% endif %}
                {% if 'mediterranean' not in cuisines %}<option value="mediterranean">Mediterranean</option>{% endif %}
                {% if 'mexican' not in cuisines %}<option value="mexican">Mexican</option>{% endif %}
                {% if 'thai' not in cuisines %}<option value="thai">Thai</option>{% endif %}
                {% if 'japanese' not in cuisines %}<option value="japanese">Japanese</option>{% endif %}
                {% if 'american' not in cuisines %}<option value="american">American</option>{% endif %}
                {% if 'french' not in cuisines %}<option value="french">French</option>{% endif %}
                {% if 'greek' not in cuisines %}<option value="greek">Greek</option>{% endif %}
            </select>
            <button type="submit"><i class="fas fa-search"></i> Find Food</button>
        </form>
    </div>
</section>

<section class="map-section">
    <div class="container">
        <h2>Explore Restaurants in Atlanta</h2>
        <div id="map" style="height: 500px; width: 100%;"></div>
    </div>
</section>

<section class="featured-restaurants">
    <div class="container">
        <div class="restaurant-grid" id="restaurant-list">
            {% for restaurant in top_restaurants %}
            <div class="restaurant-card" data-lat="{{ restaurant.latitude }}" data-lng="{{ restaurant.longitude }}" data-id="{{ restaurant.id }}">
                <img src="{{ restaurant.image.url }}" alt="{{ restaurant.name }}">
                <div class="restaurant-card-content">
                    <h3>{{ restaurant.name }}</h3>
                    <p><strong>Cuisine:</strong> {{ restaurant.cuisine }}</p>
                    <p><strong>Rating:</strong> {{ restaurant.rating }} ⭐</p>
                    <p><strong>Address:</strong> {{ restaurant.address }}</p>
                    <p><strong>Hours:</strong> {{ restaurant.opening_hours }}</p>
                    <a href="{% url 'restaurant_detail' restaurant.place_id %}" class="btn-view">View Details</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/home.js' %}"></script>
<script>
    let map;
    let markers = [];
    const restaurants = [
        {% for restaurant in restaurants %}
        {
            id: "{{ restaurant.id }}",
            place_id: "{{ restaurant.place_id }}",
            name: "{{ restaurant.name }}",
            lat: {{ restaurant.latitude|default_if_none:0 }},
            lng: {{ restaurant.longitude|default_if_none:0 }},
            cuisine: "{{ restaurant.cuisine.name|default_if_none:'' }}",
            rating: {{ restaurant.rating|default_if_none:0 }},
        },
        {% endfor %}
    ];

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 33.7490, lng: -84.3880 }, // Atlanta coordinates
            zoom: 12,
        });

        createMarkers();

        // Keep the cuisine filter functionality
        document.getElementById("cuisine-filter").addEventListener("change", filterRestaurants);
    }

    function createMarkers() {
        markers.forEach(marker => marker.setMap(null));
        markers = [];

        restaurants.forEach(restaurant => {
            if (restaurant.lat && restaurant.lng) {
                const marker = new google.maps.Marker({
                    position: { lat: restaurant.lat, lng: restaurant.lng },
                    map: map,
                    title: restaurant.name,
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `<h3>${restaurant.name}</h3><p>Cuisine: ${restaurant.cuisine}</p><p>Rating: ${restaurant.rating} ⭐</p>`
                });

                marker.addListener("click", () => {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            }
        });
    }

    function filterRestaurants() {
        const selectedCuisine = document.getElementById("cuisine-filter").value;

        const filteredRestaurants = restaurants.filter(restaurant => {
            return !selectedCuisine || restaurant.cuisine === selectedCuisine;
        });

        updateMap(filteredRestaurants);
        updateRestaurantList(filteredRestaurants);
    }

    function updateMap(filteredRestaurants) {
        markers.forEach(marker => marker.setMap(null));
        markers = [];

        filteredRestaurants.forEach(restaurant => {
            const marker = new google.maps.Marker({
                position: { lat: restaurant.lat, lng: restaurant.lng },
                map: map,
                title: restaurant.name,
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `<h3>${restaurant.name}</h3><p>Cuisine: ${restaurant.cuisine}</p><p>Rating: ${restaurant.rating} ⭐</p>`
            });

            marker.addListener("click", () => {
                infoWindow.open(map, marker);
            });

            markers.push(marker);
        });
    }

    function updateRestaurantList(filteredRestaurants) {
        const restaurantList = document.getElementById("restaurant-list");
        restaurantList.innerHTML = '';

        filteredRestaurants.forEach(restaurant => {
            const restaurantCard = document.createElement('div');
            restaurantCard.className = 'restaurant-card';
            restaurantCard.innerHTML = `
                <h3>${restaurant.name}</h3>
                <p><strong>Cuisine:</strong> ${restaurant.cuisine}</p>
                <p><strong>Rating:</strong> ${restaurant.rating} ⭐</p>
                <a href="/restaurant/${restaurant.place_id}" class="btn-view">View Details</a> <!-- Update link to use place_id -->
            `;
            restaurantList.appendChild(restaurantCard);
        });
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap&libraries=geometry" async defer></script>
{% endblock %}